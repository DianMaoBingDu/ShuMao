{% extends "base.html" %}

{% block title %}‰π¶Áå´ ShuMao{% endblock %}

{% block content %}
<header class="results-header">
    <a href="/" class="logo-container">
        <img src="{{ url_for('static', filename='logo.png') }}" alt="ShuMao Logo" class="logo-img">
        <h1 class="site-title"><span class="script-toggle" data-simp="‰π¶Áå´" data-trad="Êõ∏Ë≤ì">‰π¶Áå´</span> ShuMao</h1>
    </a>
    <form action="/search" method="get" class="search-form">
        <div class="search-input-wrapper">
            <input type="text" name="q" id="searchInput" value="{{ query }}" placeholder="Search..."
                style="padding: 8px 15px;">
            <button type="button" class="handwriting-toggle small" id="hwToggle" title="Handwriting Recognition">
                <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="currentColor"
                        d="M3,17.25V21h3.75L17.81,9.94l-3.75-3.75L3,17.25z M20.71,7.04c0.39-0.39,0.39-1.02,0-1.41l-2.34-2.34 c-0.39-0.39-1.02-0.39-1.41,0l-1.83,1.83l3.75,3.75L20.71,7.04z" />
                </svg>
            </button>
            <div id="handwritingPanel" class="handwriting-panel" style="display: none;">
                <div class="handwriting-header">
                    <div class="handwriting-candidates"></div>
                    <div class="handwriting-controls">
                        <button type="button" class="undo-btn">Undo</button>
                        <button type="button" class="clear-btn">Clear</button>
                        <button type="button" class="close-btn" title="Close">‚úï</button>
                    </div>
                </div>
                <canvas id="hwCanvas" width="256" height="256"></canvas>
            </div>
        </div>
</header>

<div class="results-container">
    {% if results %}
    <div class="results-header-bar">
        <p style="color: #888; margin: 0;">
            Showing {{ ((page - 1) * results_per_page + 1) }}-{% if page * results_per_page < total_results %}{{ page *
                results_per_page }}{% else %}{{ total_results }}{% endif %} of {{ total_results }} results
                for "{{ query }}" </p>
                <div class="script-switch">
                    <label class="switch-label">
                        <span class="switch-option" data-mode="simp">üá®üá≥</span>
                        <input type="checkbox" id="scriptToggle">
                        <span class="switch-slider"></span>
                        <span class="switch-option" data-mode="trad">üáπüáº</span>
                    </label>
                </div>
    </div>

    <div class="results-list">
        {% for row in results %}
        <details class="result-card" data-simp="{{ row['simplified'] }}" data-trad="{{ row['traditional'] }}">
            <summary class="result-summary">
                <div class="entry-chars">
                    <span class="char-display script-toggle" data-simp="{{ row['simplified'] }}"
                        data-trad="{{ row['traditional'] }}">{{ row['simplified'] }}</span>
                    <span class="pinyin" title="Pinyin">{{ row['pinyin_marks'] }}</span>
                    {% if row['hsk_level'] > 0 %}
                    <span class="hsk-badge" data-level="{{ row['hsk_level'] }}">HSK {{ '7-9' if row['hsk_level'] == 7
                        else row['hsk_level'] }}</span>
                    {% endif %}
                </div>
                <div class="defs-preview">
                    {% set def_list = row['definitions'].split('/') %}
                    <span class="def-item">{{ def_list[0] }}{% if def_list|length > 1 %}...{% endif %}</span>
                </div>
            </summary>

            <div class="result-details">
                <div class="details-bottom">
                    <div class="detail-row full-defs-row">
                        <span class="label">Definitions:</span>
                        <ul class="full-defs">
                            {% for meaning in row['definitions'].split('/') %}
                            {% if meaning %}
                            <li class="def-line">{{ meaning }}</li>
                            {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>

                {% if row['character_breakdown'] %}
                <div class="breakdown-section">
                    <h4 class="section-title">Character Breakdown</h4>
                    <table class="breakdown-table">
                        <thead>
                            <tr>
                                <th>Char</th>
                                <th>Pinyin</th>
                                <th>Definitions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for char_row in row['character_breakdown'] %}
                            <tr>
                                <td class="char-cell">
                                    <div class="char-writer-container" id="writer-{{ row['id'] }}-{{ loop.index0 }}"
                                        data-simp="{{ char_row['simplified'] }}"
                                        data-trad="{{ char_row['traditional'] }}">
                                    </div>
                                </td>
                                <td class="pinyin-cell">{{ char_row['pinyin_marks'] }}</td>
                                <td class="def-cell">{{ char_row['short_definitions'] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="details-single">
                    <div class="char-writer-container large" id="writer-{{ row['id'] }}-0"
                        data-simp="{{ row['simplified'] }}" data-trad="{{ row['traditional'] }}">
                    </div>
                </div>
                {% endif %}

                {% if row['examples'] %}
                <div class="examples-section">
                    <h4 class="section-title">Example Sentences</h4>
                    <div class="example-sentences">
                        {% for example in row['examples'] %}
                        <div class="example-item">
                            <div class="example-chinese script-toggle" data-simp="{{ example['chinese'] }}"
                                data-trad="{{ example['chinese'] }}">{{ example['chinese'] }}</div>
                            <div class="example-english">{{ example['english'] }}</div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </details>
        {% endfor %}
    </div>

    {% if total_pages > 1 %}
    <div class="pagination">
        {% if page > 1 %}
        <a href="?q={{ query }}&page={{ page - 1 }}" class="page-button">‚Üê Previous</a>
        {% else %}
        <span class="page-button disabled">‚Üê Previous</span>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <span class="page-button current">{{ p }}</span>
        {% elif p == 1 or p == total_pages or (p >= page - 2 and p <= page + 2) %} <a href="?q={{ query }}&page={{ p }}"
            class="page-button">{{ p }}</a>
            {% elif p == page - 3 or p == page + 3 %}
            <span class="page-ellipsis">...</span>
            {% endif %}
            {% endfor %}

            {% if page < total_pages %} <a href="?q={{ query }}&page={{ page + 1 }}" class="page-button">Next ‚Üí</a>
                {% else %}
                <span class="page-button disabled">Next ‚Üí</span>
                {% endif %}
    </div>
    {% endif %}
    {% else %}
    <div class="no-results">
        <h2>No results found</h2>
        <p>Sorry, we couldn't find anything for "{{ query }}".</p>
        <p>Try checking your spelling or using a simpler term.</p>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const hwToggle = document.getElementById('hwToggle');
        const hwPanel = document.getElementById('handwritingPanel');
        const searchInput = document.getElementById('searchInput');

        if (hwToggle && hwPanel) {
            hwToggle.onclick = () => {
                hwPanel.style.display = hwPanel.style.display === 'none' ? 'block' : 'none';
            };

            const closeBtn = hwPanel.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    hwPanel.style.display = 'none';
                };
            }

            initHandwriting('handwritingPanel', 'searchInput');
        }

        const toggle = document.getElementById('scriptToggle');
        const toggleElements = document.querySelectorAll('.script-toggle');
        const details = document.querySelectorAll('details.result-card');

        // Load saved preference
        const savedScript = localStorage.getItem('scriptPreference') || 'simp';
        if (savedScript === 'trad') {
            toggle.checked = true;
            updateScript(true);
        }

        toggle.addEventListener('change', function () {
            const isTraditional = this.checked;
            updateScript(isTraditional);
            localStorage.setItem('scriptPreference', isTraditional ? 'trad' : 'simp');

            // Regenerate stroke order for any open cards
            details.forEach(detail => {
                if (detail.open && detail.dataset.loaded) {
                    regenerateStrokeOrder(detail, isTraditional);
                } else if (detail.dataset.loaded) {
                    detail.dataset.loaded = "";
                }
            });
        });

        function updateScript(isTraditional) {
            toggleElements.forEach(el => {
                const text = isTraditional ? el.dataset.trad : el.dataset.simp;
                el.textContent = text;
            });
            document.title = isTraditional ? 'Êõ∏Ë≤ì ShuMao' : '‰π¶Áå´ ShuMao';
        }

        function regenerateStrokeOrder(detail, isTraditional) {
            const containers = detail.querySelectorAll('.char-writer-container');

            containers.forEach(container => {
                container.innerHTML = '';
                const char = isTraditional ? container.dataset.trad : container.dataset.simp;

                if (char && char.length === 1 && isChineseChar(char)) {
                    const isLarge = container.classList.contains('large');
                    const writerSize = isLarge ? 120 : 70;
                    const writer = HanziWriter.create(container, char, {
                        width: writerSize,
                        height: writerSize,
                        padding: 5,
                        showOutline: true,
                        strokeAnimationSpeed: 2,
                        delayBetweenStrokes: 100,
                    });
                    container.onclick = () => writer.animateCharacter();
                    writer.showCharacter(); // Show immediately instead of animating
                }
            });
        }

        details.forEach(detail => {
            detail.addEventListener('toggle', function () {
                if (this.open && !this.dataset.loaded) {
                    this.dataset.loaded = "true";
                    const isTraditional = toggle.checked;
                    regenerateStrokeOrder(this, isTraditional);
                }
            });
        });

        function isChineseChar(str) {
            const reg = /[\u4e00-\u9fa5]/;
            return reg.test(str);
        }
    });
</script>
{% endblock %}